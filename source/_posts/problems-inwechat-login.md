title: 开发微信登陆中遇到的问题记录
date: 2014-12-02 15:30:00 
categories: 技术
tags: [微信,Android]
description: 微信的文档烂到一种境界应该是业界常识了。
---

>微信的文档烂到一种境界应该是**业界常识**了。

<!--more-->


OK，让我们从头开始review一下微信登陆第三方应用我们应该做些什么：

1. 在微信开放平台上注册应用，拿到AppID和AppSecret。
2. 在开放平台上注册你的Android应用，填写好包名和使用鹅厂提供的签名生成app生成出来的MD5值。注意：需要事先给项目中添加好签名文件，如果使用的是Android Studio，那么需要在Project Structure里面设置好编译用的签名文件，否则一直run出来的都是默认的签名，使用该签名似乎无法通过校验。
3. 开放平台设置完了之后开始搞本地的事情：
    1. 注册你的应用到微信。最好在在Application全局类中完成，方法在SDK中写得很清楚，这里就不赘述了。
    2. 从你需要调用微信认证的地方发出SendAuth请求，呼起微信，方法也在SDK写得很清楚，这里也不再重复了。不过这里需要注意一点：应用签名、AppID必须和远端一致，否则无法唤起确认登陆界面。
    3. 经过以上两步，没有问题的话，你已经可以唤起微信登陆界面并且能够确认登陆了，接下来，在你的包名目录下建立一个wxapi包，然后在包下建立一个名为WXEntryActivity的activity，在manifest里面注册这个activity，并设置exported = true，之后在Activity中实现IWXAPIEventHandler这个接口，并实现里面的onResp，onCreate，onNewIntent方法，这些方法是用来在微信返回认证信息之后，我们接收intent，获取数据的时候用的。OK，准备工作做到这里，有一个***坑***，当你运行这段代码的时候，你会发现，onNewIntent方法并没有被调用，这就奇怪了，狗日的SDK文档中对这个只字未提，从正常人的思维角度上讲，既然文档中对onNewIntent的调用有需求，那么微信通过intent启动该activity的时候就应该通过在intent中addFlag的方式，主动的设置启动方式为singleTaks，这样就可以保证onCreate不被二次调用，onNewIntent可以被正常的调用了。    **OK，事实证明是我想多了，他压根儿没有这么做的意思。**在经历了一系列可能故障的排查并且浪费了我整整一下午之后，我终于意识到我一开始最不可能的事情发生了。对，整个过程在我在Manifest里面找到WXEntryActivity并在其属性中设置LaunchMode为singleTask之后结束了。
    4. OK，接下来你已经可以从onResp里面获得认证code，接下来的事情就是与服务器交互拿到用户数据了，这些就不在本文的记录范围中咯。 
    
总的来讲微信登陆还是做得比较平滑和易用的，速度也很快，给鹅厂点个赞。但是在用户手册中这样的语焉不详真的好吗？Google的时候发现大家对于鹅厂SDK文档的怨念简直遍布全网……  
接下来还会做微信分享等等一系列的开放平台接入，让我们看看我究竟还要写多少篇被坑文吧……


[1]:    {{ page.url}}  ({{ page.title }})
